# ⚡ 瞬間作文フラッシュカードプロトタイプ — 汎用仕様書

## 概要

ブラウザ上で動作するオフライン対応の言語トレーニングアプリの汎用モデル。母語（日本語など）を見て瞬時に学習言語（英語、中国語、スペイン語など）を作文して発話する練習を、フラッシュカード形式で行う。PWA対応によりスマートフォンのホーム画面からネイティブアプリのように利用可能。

---

## 技術スタック

| 項目 | 技術 |
|------|------|
| フロントエンド | Vanilla HTML / CSS / JavaScript（フレームワーク不使用） |
| データ保存 | IndexedDB（ローカル保存）＋ GitHub Gist 同期（AES-256-GCM暗号化） |
| 音声再生 | Web Speech API (SpeechSynthesis) |
| ルーティング | ハッシュベース SPA ルーター |
| PWA | Service Worker + manifest.json |
| フォント | Google Fonts (Inter, Noto Sans, または学習言語特化フォント) |

---

## 汎用データモデル

### Card（IndexedDB `cards` ストア）

| フィールド | 型 | 説明 |
|------------|------|------|
| `id` | string | UUID（主キー） |
| `native_text` | string | 母語のテキスト（プロンプト用、旧 `japanese`） |
| `target_text` | string | 学習言語のテキスト（正解用、旧 `english`） |
| `pronunciation`| string | （オプション）学習言語の発音記号や読みカナ |
| `genre` | string | ジャンル（カンマまたは読点区切りで複数可） |
| `memo` | string | メモ（任意・覚えるためのコツや文法解説など） |
| `favorite` | boolean | お気に入りフラグ（true/false） |
| `wrongCount` | number | 不正解回数（出題確率の重み付けに使用） |
| `lastAnswered` | string\|null | 最終回答日時（ISO 8601形式） |

---

## 画面構成一覧

### 1. トップ画面
- アプリタイトル・サブタイトル
- 統計指標表示（クリック/タップ可能）
  - **カード数** → カード一覧画面へ遷移
  - **ジャンル数** → ジャンル選択画面へ遷移
  - **累計ミス** → ミスが多いカード一覧画面へ遷移
- メインナビゲーションメニュー
  - ✏️ カードの作成・管理
  - 📖 クイズ（出題）を始める
  - ⭐ お気に入りリスト
  - ⚙️ アプリ設定

### 2. カード管理画面
- **カード登録フォーム**
  - 母語テキスト入力（必須）
  - 学習言語テキスト入力（必須）
  - ジャンル入力（必須・既存ジャンルのサジェスト機能付き）
  - 補足メモ入力（任意）
- **データ I/O と同期**
  - クラウド同期：GitHub Gist と Personal Access Token を用いた同期。保存される設定やデータは Web Crypto API (AES-256-GCM) によって強力に暗号化される。
  - エクスポート：全カードデータを JSON としてローカルにダウンロード
  - インポート：ローカルの JSON ファイルを読み込み、IndexedDB を更新
  - サーバーから読込：ホスティングされている初期プリセット JSON の自動取り込み
- **カードのリスト表示**
  - 各カードの情報（母語、学習言語、発音、ジャンルタグ）を一覧表示
  - リスト上から直接音声のテスト再生 (TTS) が可能
  - ワンタップでの「⭐ お気に入り」登録・解除
  - ✏️ 編集機能（モーダル内で素早く更新）
  - 🗑️ 削除機能（確認ダイアログ付き）

### 3. クイズ機能（学習モード）

#### 3a. クイズ設定・ジャンル選択
- 登録されているジャンル一覧をグリッド表示（カード枚数も表示）
- ⭐ お気に入りカード、および ❌ 要注意カードが存在する場合のみ専用のジャンルボタンを表示
- **出題モード選択:** 「母語 → 学習言語」だけでなく「学習言語 → 母語」の双方向出題モードの切り替えに対応。

#### 3b. 出題フロー
- **ステージ1 (初期表示):** 指定された出題モードのプロンプトテキストのみを大きく表示。（学習言語がプロンプトの場合はTTS自動再生）
- **ステージ2 (任意ヒント):** 「🧩 ヒント」ボタンで、発音記号やターゲット言語の直接表示など、モードに応じたヒントをプロンプトの下部に表示。
- **ステージ3 (解答表示):** 「👁️ 正解を見る」ボタンで、隠されていたテキストを大きく表示。
  - 正解表示と同時に、該当カードにメモと発音記号が設定されている場合は併せて表示。

#### 3c. 学習支援アクション
- **正誤判定ボタン:** ⭕ 正解 / ❌ 不正解（解答表示後に活性化。学習データに反映）
- **音声読み上げ (TTS):** 🔊 「音声を聞く」ボタンで、学習言語のテキストを Web Speech API を用いて発話。
- **即時アクション:** 出題・正解画面からの「テキストコピー」、「お気に入り」トグル、カード内容の「直接編集」機能を提供。

#### 3d. リザルト画面
- セッションごとの出題数、正解・不正解数、正答率の表示。
- スコアに応じた評価メッセージ・絵文字のフィードバック。
- 不正解だったカードの一覧表示とクリップボードへのテキストコピー機能。

### 4. 特定カード・リスト表示画面
- **⭐ お気に入り一覧画面:** お気に入り登録されたカードのみを抽出し、その場でクイズ開始が可能なボタンを配置。
- **❌ ミスが多いカード一覧 (要注意リスト):** `wrongCount` が1以上のカードを降順でソート表示。ボタン一つでリスト上の全カードのミス回数を 0 にリセットする一括操作機能を備える。

### 5. アプリ設定とクラウド同期画面
- **音声設定:** デバイスのOS・ブラウザが提供する学習対象言語の TTS (Text-to-Speech) 音声リストを取得し、任意の声色（Male/Female/アクセント等）を選択可能。
- **速度調整:** 読み上げスピード（Rate）を 0.5倍 〜 1.5倍 の間でスライダー調整し、テスト再生機能を提供。
- **クラウド同期 (GitHub Gist):** GitHub PAT と Gist ID を入力して、暗号化パスワードで保護されたセキュアな双方向同期を実行するUI・ステータス表示。
- **アプリ更新:** キャッシュをクリアし、最新の PWA リソースを再取得するための「アップデート」ボタン。
- (※設定内容はローカルストレージ `localStorage` に即座に保存・復元される)

---

## 主要アルゴリズム・アプリロジック

### 1. 反復学習用 出題アルゴリズム（重み付きランダム）
ユーザーの弱点カードが優先的に出題されるロジック。
- 計算式: `weight = 1 + wrongCount × 2`
- 例: 一度も間違えていないカードは重み 1。3回間違えたカードは重み 7 となり、出題確率が7倍になる。

### 2. ダイナミック穴埋め（Cloze）生成アルゴリズム
学習言語の単語区切り（主にスペース）を元に、文章の **30%〜40%** に相当する単語を自動で伏せ字化。
- 対象単語の選定: 3文字以上の意味のある単語、または誤用しやすい前置詞/助詞（`to`, `on`, `in`, `for`など）を優先的に対象とする。
- キャッシュ機能: 一度生成された穴埋めパターンは出題セッション中はキャッシュに保持され、画面の再描画が行われてもヒント内容が変わらないようにする。

### 3. ジャンル（タグ）の複数管理
- 保存形式: カンマ区切りの文字列（例: `旅行, 挨拶, ホテル`）。
- 処理: 出題ロジックや一覧表示の生成時、リアルタイムにセパレータ（`,` または `、`）でテキストを分割・トリミングし、各カードが複数のジャンルに属するものとして透過的にフィルタリング処理を行う。

---

## UI / UX・テーマ機能

- **レスポンシブデザイン:** モバイルファースト・アプローチ。タップしやすい大きなボタン要素やタッチフレンドリーなコンポーネント。
- **Glassmorphism (ガラス風デザイン):** 背景パネルに半透明とブラー（`backdrop-filter`）を適用し、背面の鮮やかなグラデーションが透けるモダンな階層構造（Elevation）を表現。
- **マイクロアニメーション:** ボタンのホバー、カードのリスト描画時、モーダルの展開やクイズ結果の遷移などに、CSS (`cubic-bezier`) で滑らかで直感的なフィードバックを提供。
- **カラーテーマ（Dark / Light）:**
  - CSS カスタムプロパティ (Variables) を活用し、プレミアム感のあるダークネイビーブルーと、柔らかなオフホワイト等のテーマを構築。
  - 画面上部のトグルボタンでテーマを切り替え（`localStorage` に永続化）。

---

## PWA (Progressive Web App) 対応

本アプリケーションをネイティブアプリと同等のユーザー体験にするための実装：

1. **Service Worker (`sw.js`):**
   - キャッシュファースト戦略。HTML, CSS, JS などのコアアセット及び初期提供 JSON を一度ロードしたらブラウザ内にキャッシュし、完全なオフライン動作を担保。
   - 新規アセットやOSキャッシュ更新時に順次キャッシュを破棄・再構築するメカニズム。
2. **Web App Manifest (`manifest.json`):**
   - `display: standalone` でブラウザUIを非表示化。画面方向 `orientation: portrait`（縦画面固定）。
   - 様々な解像度に対応するアイコン（SVG、PNG `512x512`, maskableオプション）を定義し、ホーム画面追加時に適切なアイコンを表示。
3. **iOS Specific Meta:**
   - `<meta name="apple-mobile-web-app-capable" content="yes">` 等を利用した、Safari ホーム画面追加時のステータスバー表示最適化。

---

## デプロイメント

静的ファイル（HTML/CSS/JS/JSON/画像）のみで動作するため、任意の静的ホスティングサービスで公開可能。

### 例: GitHub Pagesでのデプロイ
1. GitHub でリポジトリを作成（公開する場合は一意なランダム名などを付与するか、Private リポジトリ + 外部連携を利用）。
2. プロジェクトのすべてのファイルをリポジトリのルートにアップロード。
3. GitHubリポジトリの Settings > Pages メニューから、Source として利用ブランチ（`main` 等）を選択。
4. 提供された URL にスマートフォンからアクセスし、「**ホーム画面に追加**」を選択することでインストール完了。

---

## 🌍 別言語バージョン作成時のチェックリスト (横展開ワークフロー)

既存のフラッシュカードアプリをベースにして、別の言語バージョン（例: タイ語から広東語、韓国語などに変更）を作成する場合は、同じブラウザ・同一ドメイン上で利用した際に**データベースやキャッシュが混ざらないよう完全な分離**を行う必要があります。以下のチェックリストに沿って置換・修正を行ってください。

### 1. データベースと保存の独立化（超重要）
同じドメインで動かした際のデータ混同を防ぐため、必ず固有の名前に変更します。
- [ ] **`db.js`**: `dbName` を変更する（例: `ThaiCardDB` → `KorCardDB`）
- [ ] **`app.js`**: `localStorage` に保存する設定キー名を一括置換する（例: `thaicard_settings` → `korcard_settings`）
- [ ] **`app.js`**: エクスポート時のファイル名を変更する（例: `thaicard_backup.json` → `korcard_backup.json`）
- [ ] **`js/sync.js`**: GitHub Gist 同期時の `FILENAME` を変更する（例: `thaicard_sync.json` → `korcard_sync.json`）

### 2. オフラインキャッシュ (PWA / Service Worker) の分離
旧アプリの Service Worker が新しく追加したアプリのキャッシュを勝手に削除してしまわないよう、プレフィックスを使った判定に変更します。
- [ ] **`sw.js`**: `CACHE_NAME` を言語専用の新しい名前に変更する（例: `thaicard-v4` → `korcard-v4`）
- [ ] **`sw.js`**: `activate` イベント内のキャッシュ削除ロジックを、自分の言語のプレフィックスに合致するものだけに制限する。
  ```javascript
  if (cacheName !== CACHE_NAME && cacheName.startsWith('korcard-')) {
      return caches.delete(cacheName);
  }
  ```

### 3. アプリ全体の文言・モード置換
既存言語の残留を防ぐため、アプリ内を横断して一括置換・修正を行います。
- [ ] **クイズモード変数**: `app.js` と `index.html` にあるクイズモードの内部変数を置換する（例: `jp-th` → `jp-kor`、`th-jp` → `kor-jp`）
- [ ] **UIの表示名**: 「タイ語」や「タイ文字」といったテキストを新しい言語（「韓国語」など）に一括置換する。（検索バーのプレースホルダー等も忘れずに）
- [ ] **`index.html`**: `<title>` タグの言語名、ヘッダーのロゴ、国旗絵文字（🇹🇭 → 🇰🇷）を変更する。

### 4. 音声合成 (TTS) とフォントの最適化
- [ ] **`app.js`**: `populateVoices` 内の TTS ボイス取得フィルタリングを新しい言語コードに変更する（例: `th-TH` → `ko-KR`）
- [ ] **`app.js`**: テスト音声（`btnTestVoice`）で読み上げるための挨拶文を新しい言語にする（例: `สวัสดี` → `안녕하세요`）
- [ ] **`styles.css`**: `--font-th` 等で定義していたフォントファミリー変数を `--font-kor` 等に変更し、Google Fonts 読み込み部分 (`index.html`) も合わせて修正する（例: `Sarabun` → `Noto Sans KR`）

### 5. デザイン・アイコンの更新
- [ ] **`styles.css`**: `--primary`, `--primary-gradient` などのメインテーマカラーを、新しい言語に合わせた色味に変更する。
- [ ] **`manifest.json`**: `name`, `short_name`, `description`, `theme_color`, `background_color` を更新する。
- [ ] **画像アセット**: `icons/icon-512.png` などの PWA アイコンおよび `favicon.ico` を新しい画像の圧縮版へ差し替える。
